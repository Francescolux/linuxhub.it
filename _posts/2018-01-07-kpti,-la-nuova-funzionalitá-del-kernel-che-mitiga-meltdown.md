---
title: 'KPTI, la nuova funzionalitá del kernel che mitiga meltdown'
date: 2018-01-07
layout: post
author: Mirko B.
author_github: mirkobrombin
coauthor: linuxhub
coauthor_github: linuxhubit
tags:
  - fedora
---
<p>Una nuova serie di vulnerabilità è stata scovata di recente, si parla di meltdown. Come parte della risoluzione a questo problema, é stato introdotto nel kernel una nuova funzionalità chiamata <strong>Kernel Page Table Isolation (KPTI)</strong>.&nbsp;</p><p>Questa nuova funzione fornisce maggior protezione con alcune penalizzazioni delle prestazioni. La nuova patch é giá disponibile nelle nuove release di Fedora, effettuando <a href="https://fedoramagazine.org/protect-fedora-system-meltdown/">l'aggiornamento del kernel</a>.</p><p><a href="https://linuxhub.it/wordpress/wp-content/uploads/2018/01/meltdown-linuxhub.png"><img class=" size-full wp-image-283" alt="" height="800" src="https://linuxhub.it/wordpress/wp-content/uploads/2018/01/meltdown-linuxhub.png" width="1400" /></a></p><p>I moderni processori per computer desktop offrono diversi livelli di sicurezza per l'esecuzione del codice. Il kernel gira al livello più privilegiato (<strong>spazio del kernel</strong>) poiché ha bisogno di accedere a tutte le componenti dell'hardware. Quasi tutte le altre applicazioni funzionano a un livello di privilegio più basso (<strong>spazio utente</strong>) e fanno chiamate di sistema nel kernel per accedere ai dati privilegiati.</p><p>I processori moderni per computer desktop supportano anche la memoria virtuale. Il kernel imposta le tabelle delle pagine per controllare il mapping tra un indirizzo virtuale e un indirizzo fisico.</p><p>L'accesso tra kernel e userspace è controllato anche dalle tabelle di pagina. Una pagina mappata per il kernel non è accessibile da userspace sebbene il kernel in genere possa accedere allo spazio utente, si tratta di una misura di sicurezza.</p><p><a href="http://www.i-programmer.info/news/149-security/11437-how-meltdown-works.html"><img class=" size-full wp-image-284" alt="" height="429" src="https://linuxhub.it/wordpress/wp-content/uploads/2018/01/melt1.jpg" width="533" /></a></p><p>La conversione di queste mappature può essere lunga, pertanto l'hardware dispone di un buffer di conversione <strong>lookaside</strong> (<strong>TLB</strong>) per memorizzarle.</p><p>A volte è necessario rimuovere le vecchie mappature (<strong>flush the TLB</strong>) ma questa é un'azione a volte molto pesante e il codice è scritto per minimizzare tali chiamate. Il trucco qui è di avere sempre le tabelle della pagina del kernel mappata quando i processi dell'utente sono in esecuzione.</p><p>Le autorizzazioni della tabella di paging impediscono allo userspace di accedere alle mappature del kernel ma il kernel stesso può accedere immediatamente alle mappature quando viene effettuata una chiamata di sistema.</p><h2>L'exploit di Meltdown e il modo in cui KPTI lo mitiga</h2><p>L'exploit di Meltdown ha dimostrato che avere la mappatura del kernel disponibile in userspace può essere rischioso. I processori moderni prelevano i dati da tutte le mappature per essere eseguiti il più velocemente possibile.</p><p>Quali dati verranno precaricati dipende dall'implementazione della CPU. Quando un programma in userspace in esecuzione accede a una mappatura del kernel, si verificherà un errore e in genere il programma si blocca.</p><p>Tuttavia, la <strong>CPU può precaricare</strong> i dati del kernel senza causare alcuna modifica al programma in esecuzione. Il precaricamento di solito <strong>non è un rischio per la sicurezza</strong> grazie a dei controlli di permessi sugli indirizzi in modo che i programmi in userpace non possano accedere ai dati del kernel.</p><p>Quello che i ricercatori di Meltdown hanno scoperto è che è stato possibile misurare per quanto tempo gli accessi ai dati hanno permesso di ottenere informazioni sul sistema. Questo è ciò che viene definito un <strong>attacco di canale laterale</strong>. Le patch <strong>KPTI</strong> hanno rielaborato il modo in cui le tabelle di paging sono impostate in modo che il kernel non sia più mappato nello userspace. Ciò significa che lo spazio utente non può precaricare alcun dato del kernel e quindi l'exploit è mitigato. In realtà, scrivere un attacco per raccogliere dati utili da questo exploit può richiedere settimane o mesi per svilupparsi in un singolo sistema. Tuttavia, nell'interesse della sicurezza, le patch KPTI sono state sviluppate per chiudere questo buco.</p><p>L'effetto collaterale di non avere sempre mappate le tabelle della pagina del kernel significa che i TLB devono essere svuotati più spesso,<strong> causando una penalizzazione delle prestazioni</strong>. Per impostazione predefinita, <strong>Fedora</strong> ha abilitato KPTI per fornire maggior sicurezza agli utenti. KPTI può essere disattivato passando l'istruzione <code>nopti</code> dalla riga di comando.</p><p><strong>How Meltdown Works</strong> |&nbsp;<a href="http://www.i-programmer.info/news/149-security/11437-how-meltdown-works.html">http://www.i-programmer.info/news/149-security/11437-how-meltdown-works.html</a><br /><strong>Fedora Meltdown</strong> |&nbsp;<a href="https://fedoramagazine.org/protect-fedora-system-meltdown/">https://fedoramagazine.org/protect-fedora-system-meltdown/</a><br /><strong>Canale laterale</strong> |&nbsp;<a href="https://it.wikipedia.org/wiki/Canale_laterale">https://it.wikipedia.org/wiki/Canale_laterale</a><br /><strong>Meltdown and Spectre</strong> |<a href="https://meltdownattack.com/">&nbsp;https://meltdownattack.com/</a></p>